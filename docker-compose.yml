version: '3.8'

# --- Top-Level Volume Definitions ---
volumes:
  # 1. Volume created in Portainer
  model_request_data:
    external: true
  
  # 2. Local bind mount for logs
  data_logs:
    driver: local
  
  # 3. Volume for the Docker Model Runner
  docker-model-runner-models:
    external: true

# --- Top-Level Services Definitions ---
services:
  # 1. The SmollM2 Model Service (Using the Model Runner)
  smollm2:
    # Use the official Docker Model Runner image
    image: docker/model-runner:latest
    container_name: smollm2_service
    
    # Pass the name of the model you pulled
    environment:
      - MODEL_NAME=ai/smollm2:latest
    
    # Mount the model storage volume (using the mount syntax)
    volumes:
      - docker-model-runner-models:/model-storage
      
    # Expose the model runner's port internally
    expose:
      - 8000
    restart: unless-stopped

  # 2. Your FastAPI Application Service (User-facing API)
  fastapi-app:
    build: . # Build from the Dockerfile in the current directory
    container_name: fastapi_chat_api
    depends_on:
      - smollm2 # Ensures the model starts before the chat API
    
    # Map a host port (8080) to the container's port 8000
    ports:
      - "8080:8000"
      
    restart: unless-stopped
    
    # Mount volumes using the correct syntax: volume_name:path_in_container
    volumes:
      # Portainer volume mount
      - model_request_data:/app/model_request_data/
      # Local bind mount
      - ./data_logs:/app/data_logs/ # Adjusted path for clarity if different from model data
      
      # The fastapi-app doesn't need to mount the model-runner volume, 
      # as it accesses the model via HTTP/port 8000, not the file system.
