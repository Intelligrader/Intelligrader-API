# .github/workflows/deploy.yml
name: Continuous Deployment via SSH

# Triggers the workflow on pushes to the 'main' branch
on:
  push:
    branches:
      - main

# Ensure the workflow has permissions to check out the code
permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. Checkout repository code
        # Uses the built-in action to get your latest code
        uses: actions/checkout@v4

      - name: 2. Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.1 # A popular action for running SSH commands
        with:
          # --- Authentication and Host ---
          host: ${{ secrets.HOST_IP }}          # Uses the IP secret (e.g., 172.26.9.24)
          username: ubuntu                      # Your server username
          key: ${{ secrets.SSH_PRIVATE_KEY }}   # Uses the private key secret
          script_stop: true                     # Stop the workflow if any command fails
          
          # --- Deployment Commands ---
          script: |
            # 1. Change to the application directory on the server
            cd ~/rc_model
            
            # 2. Pull the latest code from GitHub
            git pull
            
            # 3. Use 'docker compose' to rebuild the service images and restart containers
            #    - --build: Forces a rebuild of the 'fastapi-app' image
            #    - -d: Runs the containers in detached mode (background)
            docker compose up --build -d
            
            # 4. Clean up unused images to save disk space
            docker image prune -f
            
            echo "Deployment successful on ${{ secrets.HOST_IP }}"
